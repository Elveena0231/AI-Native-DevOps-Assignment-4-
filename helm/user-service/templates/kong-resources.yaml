{{- /* Kong resources parameterized for Helm */ -}}
{{- $ns := include "user-service.namespace" . -}}
---
# Kubernetes Secret for JWT (optional)
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.kong.jwtSecretName }}
  namespace: {{ $ns }}
type: Opaque
stringData:
  jwt_secret: {{ default .Values.secretKey .Values.secrets.secretKey | quote }}

---
# Kong Plugins
{{- if has "jwt-user-service" .Values.kong.plugins }}
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: jwt-user-service
  namespace: {{ $ns }}
plugin: jwt
{{- end }}

---
{{- if has "rate-limit-ip" .Values.kong.plugins }}
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: rate-limit-ip
  namespace: {{ $ns }}
plugin: rate-limiting
config:
  minute: 10
  limit_by: ip
  policy: local
{{- end }}

---
{{- if has "custom-trace" .Values.kong.plugins }}
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: custom-trace
  namespace: {{ $ns }}
plugin: custom
config: {}
{{- end }}

---

# Kong Consumer and Credential placeholder
apiVersion: configuration.konghq.com/v1
kind: KongConsumer
metadata:
  name: user-client
  namespace: {{ $ns }}
  annotations:
    kubernetes.io/ingress.class: kong
username: user-client
credentials:
  - user-client-jwt

---
apiVersion: v1
kind: Secret
metadata:
  name: user-client-jwt
  namespace: {{ $ns }}
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    konghq.com/credential: jwt
type: Opaque
stringData:
  kongCredType: jwt
  key: user-client-key
  secret: {{ default .Values.secretKey .Values.secrets.secretKey | quote }}
  algorithm: HS256

---
# Ingress resources
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-users-ingress
  namespace: {{ $ns }}
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/plugins: {{ join "," .Values.kong.plugins }}
spec:
  rules:
    - host: {{ .Values.kong.host }}
      http:
        paths:
          - path: /users
            pathType: Prefix
            backend:
              service:
                name: {{ ternary (printf "%s-waf" (include "user-service.fullname" .)) (include "user-service.fullname" .) .Values.waf.enabled }}
                port:
                  number: {{ ternary .Values.waf.servicePort .Values.service.port .Values.waf.enabled }}

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-health-ingress
  namespace: {{ $ns }}
  annotations:
    kubernetes.io/ingress.class: kong
spec:
  rules:
    - host: {{ .Values.kong.host }}
      http:
        paths:
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: {{ include "user-service.fullname" . }}
                port:
                  number: {{ .Values.service.port }}

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: user-service-verify-ingress
  namespace: {{ $ns }}
  annotations:
    kubernetes.io/ingress.class: kong
spec:
  rules:
    - host: {{ .Values.kong.host }}
      http:
        paths:
          - path: /verify
            pathType: Prefix
            backend:
              service:
                name: {{ include "user-service.fullname" . }}
                port:
                  number: {{ .Values.service.port }}
