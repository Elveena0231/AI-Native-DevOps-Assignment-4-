{{- if .Values.kong.jwtSecretName }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "user-service.fullname" . }}-kong-patch-sa
  namespace: {{ include "user-service.namespace" . }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "user-service.fullname" . }}-kong-patch-role
  namespace: {{ include "user-service.namespace" . }}
rules:
  - apiGroups: ["configuration.konghq.com"]
    resources: ["kongcredentials"]
    verbs: ["get", "create", "patch", "update"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "user-service.fullname" . }}-kong-patch-rb
  namespace: {{ include "user-service.namespace" . }}
subjects:
  - kind: ServiceAccount
    name: {{ include "user-service.fullname" . }}-kong-patch-sa
    namespace: {{ include "user-service.namespace" . }}
roleRef:
  kind: Role
  name: {{ include "user-service.fullname" . }}-kong-patch-role
  apiGroup: rbac.authorization.k8s.io

---
# Helm hook Job: post-install/post-upgrade. It reads the secret mounted from the
# K8s Secret `kong.jwtSecretName` and patches or creates the KongCredential resource.
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "user-service.fullname" . }}-kong-patch-job
  namespace: {{ include "user-service.namespace" . }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  backoffLimit: 1
  template:
    metadata:
      name: {{ include "user-service.fullname" . }}-kong-patch-job
    spec:
      serviceAccountName: {{ include "user-service.fullname" . }}-kong-patch-sa
      restartPolicy: Never
      containers:
        - name: kong-patch
          image: bitnami/kubectl:1.27
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e
              NS={{ include "user-service.namespace" . }}
              SECRET_FILE=/secret/jwt_secret
              if [ ! -f "$SECRET_FILE" ]; then
                echo "Secret file not found: $SECRET_FILE" >&2
                exit 1
              fi
              SECRET_VAL=$(cat "$SECRET_FILE")
              cat <<EOF | kubectl apply -n "$NS" -f -
                apiVersion: configuration.konghq.com/v1
                kind: KongCredential
                metadata:
                  name: user-client-jwt
                consumerRef: user-client
                type: jwt
                config:
                  key: user-client-key
                  secret: "$SECRET_VAL"
                EOF
          volumeMounts:
            - name: jwt-secret
              mountPath: /secret
              readOnly: true
      volumes:
        - name: jwt-secret
          secret:
            secretName: {{ .Values.kong.jwtSecretName }}

{{- end }}
